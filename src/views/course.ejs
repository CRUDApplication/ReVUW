<link rel="stylesheet" href="/styles/rating.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<script src="/js/deleteReview.js"></script>

<div class="container main-content">
    <h1><%= course.courseCode %></h1>
    <p><%= course.description %></p>

    <!-- Display total number of reviews and average rating -->
    <div>
        <h3 class="header-label">Total Reviews: <%= reviews.length %></h3>
        <% if (reviews.length > 0) { %>
            <% let totalRating = reviews.reduce((sum, review) => {
                return sum + (isNaN(review.rating) ? 0 : review.rating);
            }, 0); %>
            <% let averageRating = totalRating / reviews.length; %>
            <% if (!isNaN(averageRating)) { %>
                <h3 class="header-label">Average Rating: <%= averageRating.toFixed(1) %> / 5</h3>
            <% } else { %>
                <h3 class="header-label">No ratings available.</h3>
            <% } %>
        <% } else { %>
            <h3 class="header-label">No reviews available.</h3>
        <% } %>
    </div>

    <!-- If user is authenticated, show form to post review -->
    <% if(user) { %>
        <h3 class="header-label">Post Your Review</h3>
        <form action="/courses/<%= course.courseCode %>/review" method="POST">
            <!-- Course Rating -->
            <div class="form-group">
                <label for="rating">Course Rating:</label>
                <input type="number" class="form-control" name="rating" min="1" max="5" placeholder="(1-5)" required>
            </div>
            
            <!-- Review Content -->
            <div class="form-group">
                <textarea class="form-control" name="reviewContent" rows="4" placeholder="Write your review..." required></textarea>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn btn-primary">Post Review</button>
        </form>

    <!-- Display user reviews in rows and columns -->
    <div class="row">
        <h3 class="header-label">Your Reviews</h3>
        <% let userReviews = reviews.filter(review => review.userId._id.toString() === user._id.toString()); %>
        <% userReviews.forEach((review, index) => { %>
            <%- include('components/review-card', { review: review, courseCode: course.courseCode, editable: true }) %>
            <% if ((index + 1) % 3 === 0) { %>
                </div><div class="row">
            <% } %>
        <% }); %>
    </div>

    <!-- Display other users' reviews -->
    <div class="row">
        <h3 class="header-label">Other Reviews for <%= course.courseCode %></h3>
        <% let otherReviews = reviews.filter(review => review.userId._id.toString() !== user._id.toString()); %>
        <% otherReviews.forEach((review, index) => { %>
            <%- include('components/review-card', { review: review, courseCode: course.courseCode, editable: false }) %>
            <% if ((index + 1) % 3 === 0) { %>
                </div><div class="row">
            <% } %>
        <% }); %>
    </div>
    <% } else { %>
        <!-- If user is not authenticated, show all reviews in a single section -->

        <!-- Display all reviews in rows and columns -->
        <div class="row">
            <h3 class="header-label">Users' Reviews</h3>
            <% reviews.forEach((review, index) => { %>
                <div class="col-md-4">
                    <div class="card mb-3" style="height: 120px;">
                        <div class="card-body" style="max-height: 120px; overflow-y: auto;">
                            <div class="d-flex align-items-center justify-content-between">
                                <!-- Display the course rating as stars -->
                                <div class="star-rating">
                                    <% for (let i = 1; i <= 5; i++) { %>
                                    <% if (i <= review.rating) { %>
                                    <span class="star-filled">★</span>
                                    <% } else { %>
                                    <span class="star-empty">☆</span>
                                    <% } %>
                                    <% } %>
                                </div>
                            </div>
                            <p style="margin-bottom: 0;"><p><%= review.content %></p>
                        </div>
                    </div>
                </div>
                <% if ((index + 1) % 3 === 0) { %>
                    </div><div class="row">
                <% } %>
            <% }); %>
        </div>
    <% } %>

</div>
