<link rel="stylesheet" href="/styles/course.css">
<script src="/js/deleteReview.js"></script>

<div class="container main-content">

    <div class="course-info mt-3 p-5">
        <div class="course-title d-flex justify-content-between align-items-start">
            <span>
                <h2><%= course.title %></h2>
                <p><strong>Course Code:</strong> <%= course.courseCode%></p>
            </span>
            <!-- Display SavedCourse button -->
            <% if(user) { %>
                <button title="Bookmark Course" class="bi-bookmark toggleSavedCourses" data-target="toggleSavedCourses"></button>
            <% }%>
        </div>
        <p><%= course.description %></p>
        
        <div class="stat-label d-flex">
            <p><strong>Total:&nbsp;&nbsp;</strong><%= reviews.length %> reviews</p>
            <p>|</p>
            <%let sum = 0;%>
            <%for (const review of reviews) {%>
                <%sum += review.rating || 0; %>
            <%}%>
            <% const avg = reviews.length > 0 ? sum / reviews.length : 0;%>
            <p><strong>Average Rating:&nbsp;&nbsp;</strong><span class="stars"> <%- include('./components/rating.ejs', { rating: avg.toFixed(1) }) %></span>(<%=avg.toFixed(1) %>)</p>
        </div>
    </div>

    <!-- If user is authenticated, show form to post review -->
    <% if(user) { %>
        <h3 class="header-label">Post Your Review</h3>
        <form id="reviewForm" action="/courses/<%= course.courseCode %>/review" method="POST">
            <!-- Course Rating -->
            <div class="form-group">
                <label for="rating">Course Rating:</label>
                <input type="number" class="form-control" name="rating" min="1" max="5" placeholder="(1-5)" required>
            </div>
            
            <!-- Review Content -->
            <div class="form-group">
                <textarea class="form-control" name="reviewContent" rows="4" placeholder="Write your review..." required></textarea>
            </div>

            <!-- Submit Button -->
            <button type="submit" class="btn btn-primary" onclick="submitReview()">Post Review</button>
        </form>

    <!-- Display user reviews in rows and columns -->
    <div class="row">
        <h3 class="header-label">Your Reviews</h3>
        <% let userReviews = reviews.filter(review => review.userId._id.toString() === user._id.toString()); %>
        <% userReviews.forEach((review, index) => { %>
            <%- include('components/review-card', { review: review, courseCode: course.courseCode, editable: true }) %>
            <% if ((index + 1) % 3 === 0) { %>
                </div><div class="row">
            <% } %>
        <% }); %>

    </div>

    <!-- Display other users' reviews -->
    <div class="row">
        <h3 class="header-label">Other Reviews for <%= course.courseCode %></h3>
        <% let otherReviews = reviews.filter(review => review.userId._id.toString() !== user._id.toString()); %>
        <% otherReviews.forEach((review, index) => { %>
            <%- include('components/review-card', { review: review, courseCode: course.courseCode, editable: false }) %>
            <% if ((index + 1) % 3 === 0) { %>
                </div><div class="row">
            <% } %>
        <% }); %>
    </div>
    <% } else { %>
        <!-- Keep the form but disable the textarea, and handle button click with JS -->
        <form id="reviewForm" action="/signin" method="GET">
            <!-- Course Rating -->
            <div class="form-group">
                <label for="rating">Course Rating:</label>
                <input type="number" class="form-control" name="rating" min="1" max="5" placeholder="(1-5)" disabled>
            </div>
            
            <!-- Review Content -->
            <div class="form-group">
                <textarea class="form-control" name="reviewContent" rows="4" placeholder="Write your review..." disabled></textarea>
            </div>

            <!-- Submit Button -->
            <button type="button" class="btn btn-primary" onclick="redirectToSignIn()">Post Review</button>
        </form>

        <!-- Display all reviews in rows and columns -->
        <div class="row">
            <h3 class="header-label">Users' Reviews</h3>
            <% reviews.forEach((review, index) => { %>
                <!-- Display all reviews in one section -->
                <%- include('components/review-card', { review: review, courseCode: course.courseCode, editable: false }) %>
                <% if ((index + 1) % 3 === 0) { %>
                    </div><div class="row">
                <% } %>
            <% }); %>
        </div>
    <% } %>

</div>

<script>
    function submitReview() {
        document.getElementById('reviewForm').submit();
    }

    function redirectToSignIn() {
        console.log('redirecting to sign in at /auth/signin?origin=/courses/<%= course.courseCode %>')
        window.location.href = `/auth/signin?origin=/courses/<%= course.courseCode %>`;
    }
</script>



<% if(user) { %>
    <script>
        const toggleSavedCourseButtons = document.querySelectorAll('.toggleSavedCourses');

        toggleSavedCourseButtons.forEach(async button => {
            const response = await fetch(`/courses/<%= course.courseCode %>/isSavedCourse`);
            const data = await response.json();

            if (data.isSavedCourse) {
                button.classList.remove('bi-bookmark');  // removes "unsaved"
                button.classList.add('bi-bookmark-fill');  // adds "saved" 
            } else {
                button.classList.remove('bi-bookmark-fill');  // removes "unsaved"
                button.classList.add('bi-bookmark');  // add "saved"
            }

            button.addEventListener('click', async () => {
                const toggleResponse = await fetch('/courses/<%= course.courseCode %>/toggleSavedCourses', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });

                if (!toggleResponse.ok) {
                    const errorData = await toggleResponse.text();
                    console.error("Error toggling SavedCourse serv:", errorData);
                }
                button.classList.toggle('bi-bookmark-fill'); // adds "saved"
                button.classList.toggle('bi-bookmark'); // removes "unsaved"
            });
        });
    </script>
<% } %>